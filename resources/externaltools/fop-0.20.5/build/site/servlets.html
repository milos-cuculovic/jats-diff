<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Servlets</title>
<link type="text/css" href="skin/page.css" rel="stylesheet">
</head>
<body text="#000000" bgcolor="#FFFFFF">
<!--================= start Navigation Path ==================-->
<table summary="navigation path" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<td nowrap="nowrap" valign="middle" bgcolor="#CFDCED" height="20"><img height="1" width="5" alt="" border="0" src="skin/images/spacer.gif"><!--===== breadcrumb trail (javascript-generated) ====--><font size="2" face="Arial, Helvetica, Sans-serif"><script src="skin/breadcrumbs.js" language="JavaScript" type="text/javascript"></script></font></td>
</tr>
<tr>
<td bgcolor="#4C6C8F" height="2"><img height="2" width="2" alt="" border="0" src="skin/images/spacer.gif"></td>
</tr>
</table>
<!--================= end Navigation Path ==================-->
<!--================= start Banner ==================-->
<table summary="header with logos" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<!--================= start Group Logo ==================-->
<td bgcolor="#294563"><a href="http://xml.apache.org/"><img border="0" class="logoImage" alt="Apache XML" src="images/group-logo.gif"></a></td>
<!--================= end Group Logo ==================-->
<!--================= start Project Logo ==================--><td width="100%" align="center" bgcolor="#294563"><a href="http://xml.apache.org/fop/"><img border="0" class="logoImage" alt="FOP" src="images/logo.jpg"></a></td>
<!--================= end Project Logo ==================-->
<!--================= start Search ==================--><td valign="top" rowspan="2" bgcolor="#294563">
<form target="_blank" action="http://www.google.com/search" method="get">
<table summary="search" border="0" cellspacing="0" cellpadding="0" bgcolor="#4C6C8F">
<tr>
<td colspan="3"><img height="10" width="1" alt="" src="skin/images/spacer.gif"></td>
</tr>
<tr>
<td><img height="1" width="1" alt="" src="skin/images/spacer.gif"></td><td nowrap="nowrap"><input value="xml.apache.org" name="sitesearch" type="hidden"><input size="15" name="q" id="query" type="text"><img height="1" width="5" alt="" src="skin/images/spacer.gif"><input name="Search" value="Search" type="submit">
<br>
<font face="Arial, Helvetica, Sans-serif" size="2" color="white">
                      the Apache XML site
                      
                      
                    </font></td><td><img height="1" width="1" alt="" src="skin/images/spacer.gif"></td>
</tr>
<tr>
<td><img alt="" border="0" height="10" width="9" src="skin/images/search-left.gif"></td><td><img height="1" width="1" alt="" src="skin/images/spacer.gif"></td><td><img alt="" border="0" height="10" width="9" src="skin/images/search-right.gif"></td>
</tr>
</table>
</form>
</td>
<!--================= start Search ==================--><td bgcolor="#294563"><img height="10" width="10" alt="" src="skin/images/spacer.gif"></td>
</tr>
<tr>
<td valign="bottom" bgcolor="#294563" colspan="2">
<!--================= start Tabs ==================-->
<div class="tab">
<table summary="tab bar" border="0" cellpadding="0" cellspacing="0">
<tr>
<td width="8"><img alt="" height="8" width="8" src="skin/images/spacer.gif"></td><td valign="bottom">
<table summary="selected tab" style="height: 1.7em" border="0" cellpadding="0" cellspacing="0">
<tr>
<td valign="top" width="5" bgcolor="#4C6C8F"><img height="5" width="5" alt="" src="skin/images/tabSel-left.gif"></td><td valign="middle" bgcolor="#4C6C8F"><font color="#ffffff" size="2" face="Arial, Helvetica, Sans-serif"><b><a href="index.html"><font color="#000000">Home</font></a></b></font></td><td valign="top" width="5" bgcolor="#4C6C8F"><img height="5" width="5" alt="" src="skin/images/tabSel-right.gif"></td>
</tr>
</table>
</td><td width="8"><img alt="" height="8" width="8" src="skin/images/spacer.gif"></td><td valign="bottom">
<table summary="non selected tab" style="height: 1.6em" border="0" cellpadding="0" cellspacing="0">
<tr>
<td valign="top" width="5" bgcolor="#B2C4E0"><img height="5" width="5" alt="" src="skin/images/tab-left.gif"></td><td valign="middle" bgcolor="#B2C4E0"><a href="dev/index.html"><font face="Arial, Helvetica, Sans-serif">Development</font></a></td><td valign="top" width="5" bgcolor="#B2C4E0"><img height="5" width="5" alt="" src="skin/images/tab-right.gif"></td>
</tr>
</table>
</td>
</tr>
</table>
</div>
<!--================= end Tabs ==================-->
</td><td bgcolor="#294563"><img alt="" width="1" height="1" src="skin/images/spacer.gif"></td>
</tr>
<tr>
<td bgcolor="#4C6C8F" colspan="4"><img width="1" height="10" alt="" src="skin/images/spacer.gif"></td>
</tr>
</table>
<!--================= end Banner ==================-->
<!--================= start Menu, NavBar, Content ==================-->
<table summary="page content" bgcolor="#ffffff" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<td valign="top">
<table summary="menu" border="0" cellspacing="0" cellpadding="0">
<tr>
<!--================= start left top NavBar ==================-->
<td rowspan="3" valign="top">
<table summary="blue line" border="0" cellpadding="0" cellspacing="0">
<tr>
<td bgcolor="#294563"><img width="10" height="1" alt="" src="skin/images/spacer.gif"></td>
</tr>
<tr>
<td bgcolor="#CFDCED"><font color="#4C6C8F" size="4" face="Arial, Helvetica, Sans-serif">&nbsp;</font></td>
</tr>
<tr>
<td bgcolor="#294563"><img width="10" height="1" alt="" src="skin/images/spacer.gif"></td>
</tr>
</table>
</td>
<!--================= end left top NavBar ==================--><td bgcolor="#294563"><img width="1" height="1" alt="" src="skin/images/spacer.gif"></td><td valign="bottom" bgcolor="#4C6C8F"><img width="10" height="10" alt="" src="skin/images/spacer.gif"></td><td nowrap="nowrap" valign="top" bgcolor="#4C6C8F">
<!--================= start Menu items ==================-->
<div class="menu">
<ul>
<li>
<font color="#CFDCED">Home</font>
<ul>
          
<li>
<a href="index.html">Introduction</a>
</li>
        
</ul>
</li>
<li>
<font color="#CFDCED">Using FOP</font>
<ul>
          
<li>
<a href="relnotes.html">Release Notes</a>
</li>
          
<li>
<a href="download.html">Download</a>
</li>
          
<li>
<a href="compiling.html">Build</a>
</li>
          
<li>
<a href="configuration.html">Configure</a>
</li>
          
<li>
<a href="running.html">Run</a>
</li>
          
<li>
<a href="embedding.html">Embed</a>
</li>
          
<li>
<span class="sel"><font color="#ffcc00">Servlets</font></span>
</li>
          
<li>
<a href="anttask.html">Ant task</a>
</li>
        
</ul>
</li>
<li>
<font color="#CFDCED">Features</font>
<ul>
          
<li>
<a href="compliance.html">Compliance</a>
</li>
          
<li>
<a href="output.html">Output Targets</a>
</li>
          
<li>
<a href="pdfencryption.html">PDF encryption</a>
</li>
          
<li>
<a href="graphics.html">Graphics</a>
</li>
          
<li>
<a href="fonts.html">Fonts</a>
</li>
          
<li>
<a href="hyphenation.html">Hyphenation</a>
</li>
          
<li>
<a href="extensions.html">Extensions</a>
</li>
        
</ul>
</li>
<li>
<font color="#CFDCED">Resources</font>
<ul>
          
<li>
<a href="gethelp.html">Getting Help</a>
</li>
          
<li>
<a href="faq.html">FAQs</a>
</li>
          
<li>
<a href="fo.html">XSL-FO</a>
</li>
          
<li>
<a href="examples.html">Examples</a>
</li>
          
<li>
<a href="maillist.html">Mailing Lists</a>
</li>
          
<li>
<a href="bugs.html">Bugs</a>
</li>
          
<li>
<a href="license.html">License</a>
</li>
          
<li>
<a href="resources.html">Other</a>
</li>
        
</ul>
</li>
<li>
<font color="#CFDCED">Project</font>
<ul>
          
<li>
<a href="news.html">News</a>
</li>
          
<li>
<a href="logocontest.html">Logo contest</a>
</li>
          
<li>
<a href="status.html">Status</a>
</li>
          
          
<li>
<a href="team.html">Team</a>
</li>
        
</ul>
</li>
</ul>
</div>
<!--================= end Menu items ==================-->
</td><td valign="bottom" bgcolor="#4C6C8F"><img width="10" height="10" alt="" src="skin/images/spacer.gif"></td><td bgcolor="#294563"><img width="1" height="1" alt="" src="skin/images/spacer.gif"></td>
</tr>
<tr>
<td valign="bottom" align="left" colspan="2" rowspan="2" bgcolor="#4C6C8F"><img height="10" width="10" border="0" alt="" src="skin/images/menu-left.gif"></td><td bgcolor="#4C6C8F"><img height="10" width="10" border="0" alt="" src="skin/images/spacer.gif"></td><td valign="bottom" align="right" colspan="2" rowspan="2" bgcolor="#4C6C8F"><img height="10" width="10" border="0" alt="" src="skin/images/menu-right.gif"></td>
</tr>
<tr>
<td height="1" bgcolor="#294563"><img width="1" height="1" alt="" src="skin/images/spacer.gif"></td>
</tr>
</table>
</td><td valign="top" width="100%">
<table summary="content" width="100%" border="0" cellpadding="0" cellspacing="0">
<!--================= start middle NavBar ==================-->
<tr>
<td colspan="4" bgcolor="#294563"><img width="10" height="1" alt="" src="skin/images/spacer.gif"></td>
</tr>
<tr>
<td align="left" width="10" bgcolor="#CFDCED"><img width="10" height="1" alt="" src="skin/images/spacer.gif"></td><td align="left" width="50%" bgcolor="#CFDCED"><font color="#4C6C8F" size="3" face="Arial, Helvetica, Sans-serif">
                &nbsp;
                
                </font><img width="10" height="8" alt="" src="skin/images/spacer.gif"></td><td align="right" width="50%" bgcolor="#CFDCED"><font color="#4C6C8F" size="3" face="Arial, Helvetica, Sans-serif">
                &nbsp;
                
                </font><img width="10" height="8" alt="" src="skin/images/spacer.gif"></td><td width="10" bgcolor="#CFDCED"><img width="10" height="1" alt="" src="skin/images/spacer.gif"></td>
</tr>
<tr>
<td colspan="4" bgcolor="#294563"><img width="10" height="1" alt="" src="skin/images/spacer.gif"></td>
</tr>
<!--================= end middle NavBar ==================-->
<!--================= start Content==================-->
<tr>
<td align="left" width="10"><img width="10" height="1" alt="" src="skin/images/spacer.gif"></td><td align="left" width="100%">
<div class="content">
<table class="title" summary="">
<tr>
<td valign="middle">
<h1>Servlets</h1>
</td><td nowrap="nowrap" width="80" align="center"><a class="dida" href="servlets.pdf"><img alt="printer" src="skin/images/printer.gif" border="0"><br>
          print-friendly<br>
          PDF</a></td>
</tr>
</table>
<h3>How to use FOP in a Servlet</h3>
<ul class="minitoc">
<li>
<a href="#overview">Overview</a>
</li>
<li>
<a href="#example-servlets">Example Servlets in the FOP distribution</a>
</li>
<li>
<a href="#servlet">Create your own Servlet</a>
<ul class="minitoc">
<li>
<a href="#minimal-servlet">A minimal Servlet</a>
</li>
<li>
<a href="#xslt">Adding XSL tranformation (XSLT)</a>
</li>
<li>
<a href="#cfg">Custom configuration</a>
</li>
<li>
<a href="#performance">Improving performance</a>
</li>
</ul>
</li>
<li>
<a href="#ie">Notes on Microsoft Internet Explorer</a>
</li>
<li>
<a href="#servlet-engine">Servlet Engines</a>
<ul class="minitoc">
<li>
<a href="#tomcat">Tomcat</a>
</li>
<li>
<a href="#websphere">WebSphere 3.5</a>
</li>
</ul>
</li>
<li>
<a href="#complex-usecases">Handling complex use cases</a>
</li>
</ul>
    
<a name="N101C1"></a><a name="overview"></a>
<h3>Overview</h3>
<div style="margin-left: 0 ; border: 2px">
<p>
        This page discusses topic all around using FOP in a servlet environment.
      </p>
</div>
    
<a name="N101CB"></a><a name="example-servlets"></a>
<h3>Example Servlets in the FOP distribution</h3>
<div style="margin-left: 0 ; border: 2px">
<p>
        In the directory {fop-dir}/examples/servlet, you'll find a working example
        of a FOP-enabled servlet.
      </p>
<p>
        You can build the servlet easily by using the supplied Ant script. After building 
        the servlet, drop fop.war into the webapps directory of Tomcat. Then, you can use 
        URLs like the following to generate PDF files:
      </p>
<ul>
        
<li>http://localhost:8080/fop/fop?fo=/home/path/to/fofile.fo</li>
        
<li>http://localhost:8080/fop/fop?xml=/home/path/to/xmlfile.xml&amp;xsl=/home/path/to/xslfile.xsl</li>
      
</ul>
<p></p>
<p>The source code for the servlet can be found under {fop-dir}/examples/servlet/src/FopServlet.java.</p>
</div>
    
<a name="N101E6"></a><a name="servlet"></a>
<h3>Create your own Servlet</h3>
<div style="margin-left: 0 ; border: 2px">
<div class="frame note">
<div class="label">Note</div>
<div class="content">
        This section assumes you are familiar with <a href="embedding.html">embedding FOP</a>.
      </div>
</div>
<a name="N101F3"></a><a name="minimal-servlet"></a>
<h4>A minimal Servlet</h4>
<div style="margin-left: 0 ; border: 2px">
<p>
          Here is a minimal code snippet to demonstrate the basics:
        </p>
<pre class="code">public void doGet(HttpServletRequest request,
                   HttpServletResponse response) throws ServletException {
    try {
        response.setContentType("application/pdf");
        Driver driver = new Driver(new InputSource("foo.fo"),
                                   response.getOutputStream());
        driver.setRenderer(Driver.RENDER_PDF);
        driver.run();
    } catch (Exception ex) {
        throw new ServletException(ex);
    }
}</pre>
<div class="frame note">
<div class="label">Note</div>
<div class="content">
          There are numerous problems with the code snippet above.
          Its purpose is only to demonstrate the basic concepts.
          See below for details.
        </div>
</div>
</div>
<a name="N10204"></a><a name="xslt"></a>
<h4>Adding XSL tranformation (XSLT)</h4>
<div style="margin-left: 0 ; border: 2px">
<p>
          A common requirement is the to transform an XML source to
          XSLFO using an XSL transformation. It is recommended to use
          JAXP for this task. The following snippet shows the basic
          code:
        </p>
<pre class="code">
protected Logger log;
protected TransformerFactory transformerFactory;

public void init() throws ServletException {
    this.log = new ConsoleLogger(ConsoleLogger.LEVEL_WARN);
    this.transformerFactory = TransformerFactory.newInstance();
}

[..]

    //Setup FOP
    Driver driver = new Driver();
    driver.setLogger(this.log);
    driver.setRenderer(Driver.RENDER_PDF);

    //Setup a buffer to obtain the content length
    ByteArrayOutputStream out = new ByteArrayOutputStream();
    driver.setOutputStream(out);

    //Setup Transformer
    Source xsltSrc = new StreamSource(new File("foo-xml2fo.xsl"));
    Transformer transformer = this.transformerFactory.newTransformer(xsltSrc);

    //Make sure the XSL transformation's result is piped through to FOP
    Result res = new SAXResult(driver.getContentHandler());

    //Setup input
    Source src = new StreamSource(new File("foo.xml"));

    //Start the transformation and rendering process
    transformer.transform(src, res);

    //Prepare response
    response.setContentType("application/pdf");
    response.setContentLength(out.size());
    
    //Send content to Browser
    response.getOutputStream().write(out.toByteArray());
    response.getOutputStream().flush();</pre>
<div class="frame note">
<div class="label">Note</div>
<div class="content">
          Buffering the generated PDF in a ByteArrayOutputStream is done to avoid potential 
          problems with the Acrobat Reader Plug-in in IEx.
        </div>
</div>
<p>
          The <span class="codefrag">Source</span> instance used above is simply an
          example.  If you have to read the XML from a string, supply
          a <span class="codefrag">new StreamSource(new
          StringReader(xmlstring))</span>. Constructing and reparsing
          an XML string is generally less desirable than using a
          SAXSource if you generate your XML.  You can alternatively
          supply a DOMSource as well.  You may also use dynamically
          generated XSL if you like.
        </p>
<p>
          Because you have an explicit <span class="codefrag">Transformer</span> object, you can also use it to 
          explicitly set parameters for the transformation run.
        </p>
</div>
<a name="N10224"></a><a name="cfg"></a>
<h4>Custom configuration</h4>
<div style="margin-left: 0 ; border: 2px">
<p>
          If you need to supply a special configuration do this in the <span class="codefrag">init()</span> 
          method so it will only be done once and to avoid multithreading problems.
        </p>
<pre class="code">public void init() throws ServletException {
    [..]
    new Options(new File("userconfig.xml"));
    //or
    Configuration.put("baseDir", "/my/base/dir");
}</pre>
</div>
<a name="N10235"></a><a name="performance"></a>
<h4>Improving performance</h4>
<div style="margin-left: 0 ; border: 2px">
<p>
          There are several options to consider:
        </p>
<ul>
          
<li>
            Instead of java.io.ByteArrayOutputStream consider using the ByteArrayOutputStream
            implementation from the Jakarta Commons IO project which allocates less memory.
          </li>
          
<li>
            In certain cases it can help to write the generated PDF to a temporary file so
            you can quickly reuse the file. This is especially useful, if Internet Explorer
            calls the servlet multiple times with the same request or if you often generate
            equal PDFs.
          </li>
        
</ul>
<p>
          Of course, the 
          <a href="embedding.html#performance">performance hints from the Embedding page</a>
          apply here, too.
        </p>
</div>
</div>
    
<a name="N10250"></a><a name="ie"></a>
<h3>Notes on Microsoft Internet Explorer</h3>
<div style="margin-left: 0 ; border: 2px">
<p>
        Some versions of Internet Explorer will not automatically show the PDF or call the servlet multiple times.
        These are well-known limitations of Internet Explorer and are not a problem of the servlet.
        However, Internet Explorer can still be used to download the PDF so that it can be viewed later. 
        Here are some suggestions in this context:
      </p>
<ul>
        
<li>
          Use an URL ending in <span class="codefrag">.pdf</span>, like
          <span class="codefrag">http://myserver/servlet/stuff.pdf</span>. Yes, the servlet can
          be configured to handle this. If the URL has to contain parameters,
          try to have <strong>both</strong> the base URL as well as the last parameter end in
          <span class="codefrag">.pdf</span>, if necessary append a dummy parameter, like
          <span class="codefrag">http://myserver/servlet/stuff.pdf?par1=a&amp;par2=b&amp;d=.pdf</span>. The
          effect may depend on IEx version.
        </li>
        
<li>
          Give IEx the opportunity to cache. In particular, ensure the
          server does not set any headers causing IEx not to cache the
          content. This may be a real problem if the document is sent
          over HTTPS, because most IEx installations will by default
          <em>not</em> cache any content retrieved over HTTPS.
          Setting the <span class="codefrag">Expires</span> header entry may help in
          this case:<br> 
<span class="codefrag">response.setDateHeader("Expires",
          System.currentTimeMillis() + cacheExpiringDuration *
          1000);</span>
<br> Consult your server manual and the
          relevant RFCs for further details on HTTP headers and
          caching.
        </li>
        
<li>
          Cache in the server. It may help to include a parameter in
          the URL which has a timestamp as the value min order to
          decide whether a request is repeated. IEx is reported to
          retrieve a document up to three times, but never more often.
        </li>
      
</ul>
</div>
    
<a name="N10281"></a><a name="servlet-engine"></a>
<h3>Servlet Engines</h3>
<div style="margin-left: 0 ; border: 2px">
<p>
        When using a servlet engine, there are potential CLASSPATH issues, and potential conflicts 
        with existing XML/XSLT libraries. Servlet containers also often use their own classloaders 
        for loading webapps, which can cause bugs and security problems.
      </p>
<a name="N1028A"></a><a name="tomcat"></a>
<h4>Tomcat</h4>
<div style="margin-left: 0 ; border: 2px">
<p>
          Check Tomcat's documentation for detailed instructions about installing FOP and Cocoon.
          There are known bugs that must be addressed, particularly for Tomcat 4.0.3.
        </p>
</div>
<a name="N10294"></a><a name="websphere"></a>
<h4>WebSphere 3.5</h4>
<div style="margin-left: 0 ; border: 2px">
<p>
          Put a copy of a working parser in some directory where WebSphere can access it.
          For example, if /usr/webapps/yourapp/servlets is the CLASSPATH for your servlets, 
          copy the Xerces jar into it (any other directory would also be fine).
          Do not add the jar to the servlet CLASSPATH, but add it to the CLASSPATH of the 
          application server which contains your web application.
          In the WebSphere administration console, click on the "environment" button in the 
          "general" tab. In the "variable name" box, enter "CLASSPATH".
          In the "value" box, enter the correct path to the parser jar file 
          (/usr/webapps/yourapp/servlets/Xerces.jar in our example here).
          Press "OK", then apply the change and restart the application server.
        </p>
</div>
</div>
    
<a name="N1029F"></a><a name="complex-usecases"></a>
<h3>Handling complex use cases</h3>
<div style="margin-left: 0 ; border: 2px">
<p>
        Sometimes the requirements for a servlet get quite sophisticated: SQL data sources, 
        multiple XSL transformations, merging of several datasources etc. In such a case 
        consider using <a target="_blank" href="http://cocoon.apache.org">Apache Cocoon</a> instead 
        of a custom servlet to accomplish your goal.
      </p>
</div>
  
</div>
</td><td width="10"><img width="10" height="1" alt="" src="skin/images/spacer.gif"></td>
</tr>
<!--================= end Content==================-->
</table>
</td>
</tr>
</table>
<!--================= end Menu, NavBar, Content ==================-->
<!--================= start Footer ==================-->
<table summary="footer" cellspacing="0" cellpadding="0" width="100%" border="0">
<tr>
<td colspan="2" height="1" bgcolor="#4C6C8F"><img height="1" width="1" alt="" src="skin/images/spacer.gif"><a href="skin/images/label.gif"></a><a href="skin/images/page.gif"></a><a href="skin/images/chapter.gif"></a><a href="skin/images/chapter_open.gif"></a><a href="skin/images/current.gif"></a><a href="/favicon.ico"></a></td>
</tr>
<tr>
<td colspan="2" bgcolor="#CFDCED" class="copyright" align="center"><font size="2" face="Arial, Helvetica, Sans-Serif">Copyright &copy;
          1999-2003&nbsp;The Apache Software Foundation. All rights reserved.<script type="text/javascript" language="JavaScript"><!--
              document.write(" - "+"Last Published: " + document.lastModified);
            //  --></script></font></td>
</tr>
<tr>
<td colspan="2" align="left" bgcolor="#CFDCED" class="logos"></td>
</tr>
</table>
<!--================= end Footer ==================-->
</body>
</html>
